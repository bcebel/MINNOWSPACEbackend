<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebTorrent Video Player</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        video {
            width: 100%;
            margin-top: 10px;
            max-height: 500px;
            background-color: #f0f0f0;
        }

        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }

        #videoGallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .video-card {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
        }

        #errorLog {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            display: none;
        }

        #playerContainer {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>Video Gallery</h1>
    <div id="videoGallery"></div>
    <div id="playerContainer"></div>
    <div id="errorLog"></div>

    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <script>
        const client = new WebTorrent();
        const preloadedVideos = new Map(); // Store magnetLink -> { blob, videoElement }

        function logError(message, details = null) {
            const errorLog = document.getElementById('errorLog');
            errorLog.style.display = 'block';
            errorLog.innerHTML = `<strong>Error:</strong> ${message}`;
            if (details) {
                console.error('Detailed Error:', details);
                errorLog.innerHTML += `<br><small>Check console for details</small>`;
            }
        }

        async function fetchVideos() {
            try {
                const response = await fetch("https://minnowspacebackend-e6635e46c3d0.herokuapp.com/api/videos");
                if (!response.ok) throw new Error("Failed to fetch videos.");
                return await response.json();
            } catch (error) {
                logError("Failed to fetch videos", error);
                return [];
            }
        }

        function preloadVideos(videos) {
            const toPreload = videos.slice(0, 5); // First 5 vids
            toPreload.forEach(video => {
                client.add(video.magnetLink, torrent => {
                    console.log("Preloading:", torrent.infoHash);
                    const file = torrent.files.find(f =>
                        f.name.endsWith(".mp4") || f.name.endsWith(".mkv") || f.name.endsWith(".webm")
                    );
                    if (!file) {
                        logError(`No playable file in ${video.title}`);
                        return;
                    }
                    file.getBlob((err, blob) => {
                        if (err) {
                            logError(`Failed to preload ${video.title}`, err);
                            return;
                        }
                        const videoElement = document.createElement('video');
                        videoElement.controls = true;
                        videoElement.src = URL.createObjectURL(blob);
                        videoElement.style.display = 'none'; // Hide until played
                        preloadedVideos.set(video.magnetLink, { blob, videoElement, torrent });
                        console.log(`Preloaded ${video.title}: ${file.name}, ${blob.size} bytes`);
                    });
                });
            });
        }

        function populateVideoGallery(videos) {
            const galleryContainer = document.getElementById("videoGallery");
            galleryContainer.innerHTML = "";

            videos.forEach((video, index) => {
                const videoCard = document.createElement("div");
                videoCard.className = 'video-card';
                videoCard.innerHTML = `
                    <h3>${video.title}</h3>
                    <p>Uploaded by: ${video.user.username}</p>
                    <p>${video.description || "No description"}</p>
                    <button onclick="playVideo('${video.magnetLink}', ${index})">Play</button>
                `;
                galleryContainer.appendChild(videoCard);
            });
        }

        function playVideo(magnetLink, index) {
            const playerContainer = document.getElementById("playerContainer");
            playerContainer.innerHTML = ""; // Clear old player

            const preloaded = preloadedVideos.get(magnetLink);
            if (preloaded) {
                console.log(`Playing preloaded video: ${magnetLink}`);
                preloaded.videoElement.style.display = 'block';
                preloaded.videoElement.autoplay = true;
                playerContainer.appendChild(preloaded.videoElement);
            } else {
                console.log(`Not preloaded, streaming: ${magnetLink}`);
                const tempClient = new WebTorrent();
                tempClient.add(magnetLink, torrent => {
                    const file = torrent.files.find(f =>
                        f.name.endsWith(".mp4") || f.name.endsWith(".mkv") || f.name.endsWith(".webm")
                    );
                    if (!file) {
                        logError("No playable file found.");
                        return;
                    }
                    const videoElement = document.createElement('video');
                    videoElement.controls = true;
                    videoElement.autoplay = true;
                    file.getBlob((err, blob) => {
                        if (err) {
                            logError('Failed to get blob', err);
                            return;
                        }
                        videoElement.src = URL.createObjectURL(blob);
                        playerContainer.appendChild(videoElement);
                    });
                });
            }

            // Preload next batch if near end
            if (index >= preloadedVideos.size - 2) {
                preloadNextBatch();
            }
        }

        let currentVideoIndex = 5;
        async function preloadNextBatch() {
            const videos = await fetchVideos();
            const nextBatch = videos.slice(currentVideoIndex, currentVideoIndex + 5);
            preloadVideos(nextBatch);
            currentVideoIndex += 5;
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const videos = await fetchVideos();
            populateVideoGallery(videos);
            preloadVideos(videos); // Start with first 5
        });
    </script>
</body>

</html>