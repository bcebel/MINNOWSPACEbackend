<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebTorrent Video Player</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        video {
            width: 100%;
            margin-top: 10px;
            max-height: 500px;
            background-color: #f0f0f0;
        }

        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }

        #videoGallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .video-card {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
        }

        #errorLog {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            display: none;
        }

        #playerContainer {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>Video Gallery</h1>
    <div id="videoGallery"></div>
    <div id="playerContainer"></div>
    <div id="errorLog"></div>

    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <script>
        const client = new WebTorrent();
        const preloadedVideos = new Map();

        function logError(message, details = null) {
            const errorLog = document.getElementById('errorLog');
            errorLog.style.display = 'block';
            errorLog.innerHTML = `<strong>Error:</strong> ${message}`;
            if (details) console.error('Details:', details);
        }

        async function fetchVideos() {
            try {
                console.log("Fetching /api/videos...");
                const response = await fetch("https://minnowspacebackend-e6635e46c3d0.herokuapp.com/api/videos");
                console.log("API status:", response.status);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const videos = await response.json();
                console.log("Fetched:", videos);
                return videos;
            } catch (error) {
                logError("Fetch failed", error);
                return [];
            }
        }

        function preloadVideos(videos) {
            const toPreload = videos.slice(0, 5);
            console.log("Preloading", toPreload.length, "videos...");
            toPreload.forEach(video => {
                console.log("Seeding:", video.magnetLink);
                const torrent = client.add(video.magnetLink);
                torrent.on('error', err => logError(`Torrent error for ${video.title}`, err));
                torrent.on('metadata', () => console.log("Metadata:", torrent.infoHash, "Peers:", torrent.numPeers));
                torrent.on('ready', () => {
                    const file = torrent.files.find(f =>
                        f.name.endsWith(".mp4") || f.name.endsWith(".mkv") || f.name.endsWith(".webm")
                    );
                    if (!file) {
                        logError(`No file in ${video.title}`);
                        return;
                    }
                    console.log("File:", file.name, file.length);
                    file.getBlob((err, blob) => {
                        if (err) {
                            logError(`Blob fail for ${video.title}`, err);
                            return;
                        }
                        const videoElement = document.createElement('video');
                        videoElement.controls = true;
                        videoElement.src = URL.createObjectURL(blob);
                        videoElement.style.display = 'none';
                        preloadedVideos.set(video.magnetLink, { blob, videoElement, torrent });
                        console.log(`Preloaded ${video.title}: ${blob.size} bytes`);
                    });
                });
            });
        }

        function populateVideoGallery(videos) {
            const galleryContainer = document.getElementById("videoGallery");
            galleryContainer.innerHTML = "";
            console.log("Gallery populating:", videos.length);
            videos.forEach((video, index) => {
                const videoCard = document.createElement("div");
                videoCard.className = 'video-card';
                videoCard.innerHTML = `
                    <h3>${video.title}</h3>
                    <p>By: ${video.user?.username || 'Unknown'}</p>
                    <p>${video.description || "No desc"}</p>
                    <button onclick="playVideo('${video.magnetLink}', ${index}, '${video.ipfsUrl || ''}')">Play</button>
                `;
                galleryContainer.appendChild(videoCard);
            });
        }

        function playVideo(magnetLink, index, ipfsUrl) {
            const playerContainer = document.getElementById("playerContainer");
            playerContainer.innerHTML = "";
            console.log("Playing:", magnetLink);

            const preloaded = preloadedVideos.get(magnetLink);
            if (preloaded) {
                console.log("Preloaded play");
                preloaded.videoElement.style.display = 'block';
                preloaded.videoElement.autoplay = true;
                playerContainer.appendChild(preloaded.videoElement);
            } else if (ipfsUrl) {
                console.log("Falling back to IPFS:", ipfsUrl);
                const videoElement = document.createElement('video');
                videoElement.controls = true;
                videoElement.autoplay = true;
                videoElement.src = ipfsUrl;
                playerContainer.appendChild(videoElement);
            } else {
                console.log("Streaming...");
                const tempClient = new WebTorrent();
                const torrent = tempClient.add(magnetLink);
                torrent.on('error', err => logError("Stream error", err));
                torrent.on('metadata', () => console.log("Stream metadata:", torrent.infoHash, "Peers:", torrent.numPeers));
                torrent.on('ready', () => {
                    const file = torrent.files.find(f =>
                        f.name.endsWith(".mp4") || f.name.endsWith(".mkv") || f.name.endsWith(".webm")
                    );
                    if (!file) {
                        logError("No file");
                        return;
                    }
                    console.log("Stream file:", file.name, file.length);
                    file.getBlob((err, blob) => {
                        if (err) {
                            logError("Blob fail", err);
                            return;
                        }
                        const videoElement = document.createElement('video');
                        videoElement.controls = true;
                        videoElement.autoplay = true;
                        videoElement.src = URL.createObjectURL(blob);
                        playerContainer.appendChild(videoElement);
                        console.log("Streamed:", blob.size);
                    });
                });
            }

            if (index >= preloadedVideos.size - 2) preloadNextBatch();
        }

        let currentVideoIndex = 5;
        async function preloadNextBatch() {
            const videos = await fetchVideos();
            const nextBatch = videos.slice(currentVideoIndex, currentVideoIndex + 5);
            console.log("Next batch:", nextBatch.length);
            preloadVideos(nextBatch);
            currentVideoIndex += 5;
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const videos = await fetchVideos();
            const testVideo = {
                title: "Test Stream",
                user: { username: "punk48" },
                description: "Live strike vid",
                magnetLink: "magnet:?xt=urn:btih:d711b6ed8f9f0a272af93fd769afa27252c7f2bb&dn=bafybeidk5yfiuc6tq3wouwjicdqmciucrfchlayes6qmiwfnjdpt4gqa5m.mp4&tr=wss%3A%2F%2Ftracker.openwebtorrent.com&tr=udp%3A%2F%2Ftracker.opentrackr.org%3A1337%2Fannounce&tr=udp%3A%2F%2Ftracker.internetwarriors.net%3A1337%2Fannounce&tr=udp%3A%2F%2Ftracker.torrent.eu.org%3A451%2Fannounce&tr=udp%3A%2F%2Ftracker.coppersurfer.tk%3A6969%2Fannounce",
                ipfsUrl: "https://ipfs.io/ipfs/bafybeidk5yfiuc6tq3wouwjicdqmciucrfchlayes6qmiwfnjdpt4gqa5m" // If youâ€™ve got it
            };
            videos.push(testVideo);
            populateVideoGallery(videos);
            preloadVideos(videos.slice(0, 5));
        });
    </script>
</body>

</html>